(()=>{"use strict";const e="1.4",t="plains",a="desert",s="snow",o="hell",r="space",n="mars",i="none",l="plain",c="water",d="iron",p="tree",u="rock",m="bridge",_="steam",h="thorn",g="station-l",b="station-r",y="station-f",f="color-1",k="color-2",v="color-3",w="color-4",x="color-5",L="color-6",A="color-7",T="color-8",E="color-9",M="color-10",I="none",S="c-rail",C="rail",P="resource-wood",$="resource-iron",W="resource-dynamite-1",z="resource-backet",O="resource-backet-empty",D="resource-axe",B="resource-pickaxe",R="resource-bolt",N="resource-eraser",j="resource-face",U="resource-symbol",Q="symbol-eraser",q="symbol-symbol",F="symbol-face",H="symbol-none",X="mine-axe-and-pickaxe",Y="mine-dynamite",G="land",J="resource",V="symbol",K="mine",Z="train",ee=[[0,-1],[1,0],[0,1],[-1,0]],te=-1,ae=["CraftingWagon","StorageWagon","TankWagon","DynamiteWagon","SuperchargerWagon","CollectorWagon","BrakeWagon","GhostWagon","BuckinatorWagon","MilkWagon","MinerWagon","TransformerWagon","SlotMachineWagon","LightWagon","CompassWagon","CannonWagon"],se={"○":3,"■":3,"１":2,"２":1,"３":0},oe=["\n\t■■■\n\t■○■\n\t■■■\n\t","\n\t１１■１１\n\t１■■■１\n\t■■○■■\n\t１■■■１\n\t１１■１１\n\t","\n\t３２■■■２３\n\t２■■■■■２\n\t■■■■■■■\n\t■■■○■■■\n\t■■■■■■■\n\t２■■■■■２\n\t３２■■■２３\n\t","\n\t３３■■■■■３３\n\t３■■■■■■■３\n\t■■■■■■■■■\n\t■■■■■■■■■\n\t■■■■○■■■■\n\t■■■■■■■■■\n\t■■■■■■■■■\n\t３■■■■■■■３\n\t３３■■■■■３３\n\t","\n\t３３■■■■■■■３３\n\t３■■■■■■■■■３\n\t■■■■■■■■■■■\n\t■■■■■■■■■■■\n\t■■■■■■■■■■■\n\t■■■■■○■■■■■\n\t■■■■■■■■■■■\n\t■■■■■■■■■■■\n\t■■■■■■■■■■■\n\t３■■■■■■■■■３\n\t３３■■■■■■■３３\n\t","\n\t３３３■■■■■■■３３３\n\t３３■■■■■■■■■３３\n\t３■■■■■■■■■■■３\n\t■■■■■■■■■■■■■\n\t■■■■■■■■■■■■■\n\t■■■■■■■■■■■■■\n\t■■■■■■○■■■■■■\n\t■■■■■■■■■■■■■\n\t■■■■■■■■■■■■■\n\t■■■■■■■■■■■■■\n\t３■■■■■■■■■■■３\n\t３３■■■■■■■■■３３\n\t３３３■■■■■■■３３３\n\t","\n\t３３３３■■■■■■■３３３３\n\t３３■■■■■■■■■■■３３\n\t３■■■■■■■■■■■■■３\n\t３■■■■■■■■■■■■■３\n\t■■■■■■■■■■■■■■■\n\t■■■■■■■■■■■■■■■\n\t■■■■■■■■■■■■■■■\n\t■■■■■■■○■■■■■■■\n\t■■■■■■■■■■■■■■■\n\t■■■■■■■■■■■■■■■\n\t■■■■■■■■■■■■■■■\n\t３■■■■■■■■■■■■■３\n\t３■■■■■■■■■■■■■３\n\t３３■■■■■■■■■■■３３\n\t３３３３■■■■■■■３３３３\n\t","\n\t３３３３■■■■■■■■■３３３３\n\t３３３■■■■■■■■■■■３３３\n\t３３■■■■■■■■■■■■■３３\n\t３■■■■■■■■■■■■■■■３\n\t■■■■■■■■■■■■■■■■■\n\t■■■■■■■■■■■■■■■■■\n\t■■■■■■■■■■■■■■■■■\n\t■■■■■■■■■■■■■■■■■\n\t■■■■■■■■○■■■■■■■■\n\t■■■■■■■■■■■■■■■■■\n\t■■■■■■■■■■■■■■■■■\n\t■■■■■■■■■■■■■■■■■\n\t■■■■■■■■■■■■■■■■■\n\t３■■■■■■■■■■■■■■■３\n\t３３■■■■■■■■■■■■■３３\n\t３３３■■■■■■■■■■■３３３\n\t３３３３■■■■■■■■■３３３３\n\t","\n\t３３３３３■■■■■■■■■３３３３３\n\t３３３３■■■■■■■■■■■３３３３\n\t３３■■■■■■■■■■■■■■■３３\n\t３３■■■■■■■■■■■■■■■３３\n\t３■■■■■■■■■■■■■■■■■３\n\t■■■■■■■■■■■■■■■■■■■\n\t■■■■■■■■■■■■■■■■■■■\n\t■■■■■■■■■■■■■■■■■■■\n\t■■■■■■■■■■■■■■■■■■■\n\t■■■■■■■■■○■■■■■■■■■\n\t■■■■■■■■■■■■■■■■■■■\n\t■■■■■■■■■■■■■■■■■■■\n\t■■■■■■■■■■■■■■■■■■■\n\t■■■■■■■■■■■■■■■■■■■\n\t３■■■■■■■■■■■■■■■■■３\n\t３３■■■■■■■■■■■■■■■３３\n\t３３■■■■■■■■■■■■■■■３３\n\t３３３３■■■■■■■■■■■３３３３\n\t３３３３３■■■■■■■■■３３３３３\n\t"],re=(()=>{const e=[];return oe.forEach((t=>{let a=0;const s=[];t.split("\n").forEach((e=>{const t=e.trim();if(t){s[a]=[];for(let e=0;e<t.length;e++){const o=t.charAt(e),r=se[o];s[a][e]=r}a++}})),e.push(s)})),e})(),ne=(()=>{const e={};return'\npalette-none|未生成|None\npalette-plain|平地|Plain\npalette-water|水|Water\npalette-iron|鉄|Iron\npalette-tree|木|Wood\npalette-color|色|Color\npalette-rock|黒岩|Black Rock\npalette-bridge|橋|Bridge\npalette-station-l|駅|Station\npalette-station-f|柵|Fence\npalette-c-rail|接続された線路|Connected Rail\npalette-rail|線路|Rail\npalette-color-1|色|Color\npalette-resource-bolt|ボルト|Bolt\npalette-resource-wood|木材|Wood\npalette-resource-iron|鉄材|Iron\npalette-resource-dynamite-1|ダイナマイト Lv1|Dynamite Lv1\npalette-resource-dynamite-2|ダイナマイト Lv2|Dynamite Lv2\npalette-resource-dynamite-3|ダイナマイト Lv3|Dynamite Lv3\npalette-resource-dynamite-4|ダイナマイト Lv4|Dynamite Lv4\npalette-resource-dynamite-5|ダイナマイト Lv5|Dynamite Lv5\npalette-resource-dynamite-6|ダイナマイト Lv6|Dynamite Lv6\npalette-resource-dynamite-7|ダイナマイト Lv7|Dynamite Lv7\npalette-resource-dynamite-8|ダイナマイト Lv8|Dynamite Lv8\npalette-resource-dynamite-9|ダイナマイト Lv9|Dynamite Lv9\npalette-resource-backet|バケツ|Backet\npalette-resource-backet-empty|バケツ(空)|Backet (empty)\npalette-resource-axe|斧|Axe\npalette-resource-pickaxe|つるはし|Pickaxe\npalette-resource-eraser|消しゴム(アイテムを消す)|Eraser (Remove Items)\npalette-resource-face|キャラクター|Character\npalette-symbol-eraser|消しゴム(記号を消す)|Eraser\npalette-symbol-symbol|記号|Symbol\npalette-symbol-face|キャラクター|Character\npalette-mine-axe-and-pickaxe|斧とつるはしで採掘する|Mine with axe and pickaxe\npalette-mine-dynamite|ダイナマイトで採掘する|Mine with dynamite\npalette-train|列車を置く|Put train\ntoolbar-help|ヘルプ|Help\ntoolbar-file|ファイル|File\ntoolbar-save|保存|Save\ntoolbar-save-as|名前を付けて保存|Save As\ntoolbar-load|読み込む|Load\ntoolbar-open|開く|Open\ntoolbar-new|新規作成|New\ntoolbar-grounds|地形|Grounds\ntoolbar-items|アイテム|Items\ntoolbar-symbols|記号|Symbols\ntoolbar-mine-tools|採掘|Mine\ntoolbar-train|列車|Train\ntoolbar-map-size|マップサイズ|Map Size\ntoolbar-grid|罫線|Grid\ntoolbar-count|カウンター|Counter\ntoolbar-download-image|画像を保存|Download Image\ntoolbar-share|共有|Share\ntoolbar-share-url|共有URL|Share URL\ntoolbar-embed-tag|埋め込み用タグ|Embet Tag\ntoolbar-copy|コピー|Copy\ntoolbar-close|閉じる|Close\ntoolbar-train|列車|Train\ntoolbar-delete|削除|Delete\ntoolbar-undo|戻す|Undo\ntoolbar-redo|進む|Redo\ntoolbar-train-edit|編集|Edit\ntoolbar-train-reverse|反転|Reverse\ntoolbar-train-remove|削除|Remove\ntrain-edit-description-1|ワゴンの追加 ⋯ パレットのワゴンをクリック|Add wagon ... Click on the wagon in the palette\ntrain-edit-description-2|ワゴンの変更 ⋯ パレットのワゴンを列車のワゴンにドラッグ＆ドロップ|Change wagon ... drag and drop pallet wagon to train wagon\ntrain-edit-description-3|ワゴンの並べ替え ⋯ 列車のワゴンをドラッグ＆ドロップ|Rearrange wagons ... Drag and drop train wagons\ntrain-edit-description-4|ワゴンの削除 ⋯ 列車のワゴンをゴミ箱または列車の外側にドラッグ＆ドロップ|Remove wagons ... Drag and drop train wagons to the trash or outside the train\ntoaster-init|Unrailed! Map Maker Ver.{num} へようこそ！|Welcome to Unrailed! Map Maker Ver.{num}!\ntoaster-load-share-url|共有URLのデータを読み込みました。|Loaded the data from the shared URL.\ntoaster-success-copy|コピーしました！|Copied!\ntoaster-success-save|保存しました！|Saved!\ntoaster-success-load|ロードしました！|Opened!\ntoaster-success-new|新規作成しました。|Created new file.\ntoaster-success-save-state|スロット[{num}]に一時保存しました。|Temporarily saved in slot {num}.\ntoaster-success-load-state|スロット[{num}]をロードしました。|Slot {num} is loaded.\ntoaster-success-load-state-error|スロット[{num}]にデータがありません。|No data in slot {num}.\ncount-wood|木の数|Wood\ncount-iron|鉄の数|Iron\ncount-r-wood|木(資材)の数|Woods (Material)\ncount-r-iron|鉄(資材)の数|Irons (Material)\ncount-r-rail|線路(資材)の数|Rails (Material)\ncount-c-rail|接続された線路の数|Rails (Connected)\ncount-bridge|橋の数|Bridges\ncount-sup|※駅の下3マスを除く|*Excluding under stations.\nopen-table-title|ファイル名|Title\nopen-table-created|作成日時|Created\nopen-table-modified|更新日時|Modified\nopen-table-open|開く|Open\nopen-table-delete|削除|Delete\nconfirm-delete|「{name}」を削除します。よろしいですか？|Delete "{name}". Are you sure?\nconfirm-new|現在編集中の内容は失われます。よろしいですか？|Any content currently being edited will be lost. Are you sure?\nCraftingWagon    |クラフトワゴン        |Crafting Wagon\nStorageWagon     |貨物ワゴン            |Storage Wagon\nTankWagon        |タンクワゴン          |Tank Wagon\nDynamiteWagon    |ダイナマイトワゴン    |Dynamite Wagon\nSuperchargerWagon|スーパーチャージワゴン|Supercharger Wagon\nCollectorWagon   |バキュームワゴン      |Collector Wagon\nBrakeWagon       |ブレーキワゴン        |Brake Wagon\nGhostWagon       |ゴーストワゴン        |Ghost Wagon\nBuckinatorWagon  |バッキネーター        |Buckinator Wagon\nMilkWagon        |ミルクワゴン          |Milk Wagon\nMinerWagon       |採掘ワゴン            |Miner Wagon\nTransformerWagon |変換ワゴン            |Transformer Wagon\nSlotMachineWagon |スロットワゴン        |SlotMachine Wagon\nLightWagon       |照明ワゴン            |Light Wagon\nCompassWagon     |コンパスワゴン        |Compass Wagon\nCannonWagon      |大砲ワゴン            |Cannon Wagon\n'.split("\n").forEach((t=>{const a=t.trim();if(!a)return;const s=a.split("|");e[s[0].trim()]={ja:s[1].trim(),en:s[2].trim()}})),e})(),ie={main_window:null,modal_window:null,map_biome:t,count_wrapper:null,count_elm:{},map_wrapper:null,map_cell:null,map_elm:null,save_data:{file:{},last_file_key:null,embed_option:{embed_size:"cell-size",map_size:800,cell_size:32},download_image_option:{cell_size:64,map_size:800,type:"png",quality:.8},option:{is_enabled_count:!1,is_enabled_grid:!1}},current_file_key:null,is_autosave_enabled:!0,autosave_timer:null,autosave_timer_sub:null,is_saved:!0,state_save_data:{},image_cache:{},url_queries:ge(),lang_key:function(){const e=navigator.language||navigator.userLanguage||"ja",t=ge();return"en"===t.lang?"en":"ja"===t.lang||e.includes("ja")?"ja":"en"}(),mouse_state:{is_down:!1,current_palette_item:null,current_palette_type:"land",last_put_cell:null,last_move_cell:null,changed:!1},key_state:{},last_highlight_cell:null,route_highlight_cells:[]},le={get_time_str(){const e=new Date;return`${e.getHours().padding(1)}:${e.getMinutes().padding(2)}:${e.getSeconds().padding(2)}`},hr(){console.log("------------------------------")},log(e){"string"==typeof e?console.log(`${this.get_time_str()} ${e}`):console.log(`${this.get_time_str()} %o`,e)},error(e){console.error(`${this.get_time_str()} ${e}`)},info(e){console.info(`${this.get_time_str()} ${e}`)}},ce={root_cell:null,alpha:0,elm:{},wagon_names:["CraftingWagon","StorageWagon","DynamiteWagon","DynamiteWagon","TankWagon"],cell_size:32,put(e,t="to",a=0){if(e.resource_type===S){if(this.root_cell=e,this.elm.container)return this.alpha=a,void this.update_train_pos();this.dir=t,this.dir_rev=Ee(this.dir),["to","from"].forEach((t=>{const a=Ee(t);let s,o=e;for(let r=0;r<999&&(s=o.get_next_rail(t),s&&s!==e);r++){if(s.get_next_rail(a)===o);else{const e=s.rail_dir[t];s.rail_dir[t]=s.rail_dir[a],s.rail_dir[a]=e}o=s}})),this.elm.container=fe("div.train-container").appendTo(ie.map_wrapper),this.elm.engine=fe("div.train-part.train-engine").appendTo(this.elm.container),this.alpha=a,this.elm.wagons=[],this.wagon_names.forEach(((e,t)=>{this.elm.wagons[t]=fe("div.train-part.train-wagon").appendTo(this.elm.container),this.elm.wagons[t].css("background-image","url(./assets/img/train/"+e+".png)")})),this.update_train_pos(),window.onkeydown=e=>{"ArrowRight"===e.key?this.step(.1):"ArrowLeft"===e.key&&this.step(-.1)}}else le.error("There are no tracks laid in this cell.")},update_wagons(e){if(this.wagon_names=e,this.elm.container)return this.remove(),void this.put(this.root_cell,this.dir,this.alpha)},encode(e){let t="";return e.forEach((e=>{const a=ae.indexOf(e);a>-1&&(t+=a.toAlphabet())})),t},decode(e){const t=[];for(let a=0;a<e.length;a++){const s=e[a].toNumber(),o=ae[s];t.push(o)}return t},reverse(){this.elm.container&&(this.dir=Ee(this.dir),this.dir_rev=Ee(this.dir),this.update_train_pos())},remove(){this.elm.container&&this.elm.container.remove(),this.elm={}},step(e){if(this.elm.container){if(this.alpha+=e,this.alpha>=1){const e=this.root_cell.get_next_rail(this.dir);e&&e.get_next_rail(this.dir)?(this.root_cell=e,this.alpha-=1):this.alpha=1}else if(this.alpha<0){const e=this.root_cell.get_next_rail(this.dir_rev);e&&e.get_next_rail(this.dir_rev)?(this.root_cell=e,this.alpha+=1):this.alpha=0}this.update_train_pos()}},update_train_pos(){let e=this.alpha;const t=this.get_pos_in_cell(this.root_cell,e);this.elm.engine.style.setProperty("left",`${t.x}px`),this.elm.engine.style.setProperty("top",`${t.y}px`),this.elm.engine.style.setProperty("--rotate",`${t.rotate}deg`),e-=1.825,this.elm.wagons.forEach((t=>{const a=this.calc_wagon_pos(e);t.css({left:`${a.x}px`,top:`${a.y}px`,"--rotate":`${a.rotate}deg`}),e-=1.65}))},calc_wagon_pos(e){let t,a=null,s=this.root_cell.get_next_rail(this.dir_rev),o=s&&s.get_next_rail(this.dir_rev),r=0;for(let n=0;n<99;n++){if(!o){t=this.get_pos_in_cell(s||this.root_cell,1);break}if(r<=e&&e<r+1){const a=e-r;t=this.get_pos_in_cell(s||this.root_cell,a);break}r--,a=s,n>0&&(s=s.get_next_rail(this.dir_rev),o=s.get_next_rail(this.dir_rev))}return t},get_pos_in_cell(e,t){let a=0,s=0,o=0;switch(e.td.getAttribute("rail-direction")){case"tb":0===e.rail_dir[this.dir]&&(t=1-t,o+=180),o+=90,a=.5,s=t;break;case"rl":3===e.rail_dir[this.dir]&&(t=1-t,o+=180),o+=0,a=t,s=.5;break;case"tr":0===e.rail_dir[this.dir]&&(t=1-t,o+=180),o+=Me.easeInOutQuad(t,90,-90,1),a=Me.easeInQuad(t,.5,.5,1),s=Me.easeOutQuad(t,0,.5,1);break;case"rb":1===e.rail_dir[this.dir]&&(t=1-t,o+=180),o+=Me.easeInOutQuad(t,180,-90,1),a=Me.easeOutQuad(t,1,-.5,1),s=Me.easeInQuad(t,.5,.5,1);break;case"bl":2===e.rail_dir[this.dir]&&(t=1-t,o+=180),o+=Me.easeInOutQuad(t,270,-90,1),a=Me.easeInQuad(t,.5,-.5,1),s=Me.easeOutQuad(t,1,-.5,1);break;case"tl":3===e.rail_dir[this.dir]&&(t=1-t,o+=180),o+=Me.easeInOutQuad(t,0,-90,1),a=Me.easeOutQuad(t,0,.5,1),s=Me.easeInQuad(t,.5,-.5,1)}return a+=e.x,s+=e.y,a*=this.cell_size,s*=this.cell_size,{x:a,y:s,rotate:o}}},de={reset(){ye(".highlight-frame").forEach((e=>{e.classList.remove("highlight-frame"),e.classList.remove("highlight-circle"),ie.route_highlight_cells=[]}))},mouse(e){if(ie.last_highlight_cell===ie.mouse_state.last_move_cell)return;this.reset();const t=ie.mouse_state.last_move_cell;if(t.td.classList.add("highlight-frame"),ie.mouse_state.current_palette_item===g){const e=t.right();e&&e.td.classList.add("highlight-frame")}},dynamite(e){if(!ie.mouse_state.last_move_cell)return;if(ie.last_highlight_cell===ie.mouse_state.last_move_cell)return;isNaN(e)&&(e=1),this.reset();const t=we(ie.mouse_state.last_move_cell,e);t&&t.length&&(t.forEach(((e,t)=>{e.power>0&&(e.cell.td.classList.add("highlight-frame"),ie.route_highlight_cells.push(e.cell),e.cell===ie.mouse_state.last_move_cell&&e.cell.td.classList.add("highlight-circle"))})),ie.last_highlight_cell=ie.mouse_state.last_move_cell)},route(e){if(!ie.mouse_state.last_put_cell||!ie.mouse_state.last_move_cell)return;if(!ie.mouse_state.last_put_cell||!ie.mouse_state.last_move_cell)return;if(ie.mouse_state.last_put_cell===ie.mouse_state.last_move_cell)return;if(ie.last_highlight_cell===ie.mouse_state.last_move_cell)return;let t;this.reset(),t=e?function(e,t){for(let e=0;e<ie.map_cell.length;e++)for(let t=0;t<ie.map_cell[e].length;t++)ie.map_cell[e][t].explore_data={score:-1/0,from:null,is_end:!1};e.explore_data.score=0,t.explore_data.is_end=!0,Le(e,0);const a=[];if(t.explore_data.from){let s=t;for(let t=0;t<9999&&(a.push(s),s!==e);t++)s=s.explore_data.from;a.reverse()}return a}(ie.mouse_state.last_put_cell,ie.mouse_state.last_move_cell):xe(ie.mouse_state.last_put_cell,ie.mouse_state.last_move_cell),t&&(t.forEach(((e,a)=>{a>0&&(e.td.classList.add("highlight-frame"),ie.route_highlight_cells.push(e),a===t.length-1&&e.td.classList.add("highlight-circle"))})),ie.last_highlight_cell=ie.mouse_state.last_move_cell)}},pe={init(){let e,t;this.timer,this.image=document.getElementById("bot-image"),this.head=document.getElementById("bot-head-area"),this.balloon=document.getElementById("bot-balloon"),this.loaded_src={};let a=0,s=-1,o=-1;this.image.addEventListener("mouseenter",(t=>{clearTimeout(e),e=setTimeout((()=>{this.emoji("p2-7")}),1e3)})),this.image.addEventListener("mouseleave",(r=>{clearTimeout(e),t=setTimeout((()=>{a=0,s=-1,o=-1}),1e3)})),this.head.addEventListener("mousemove",(e=>{if(clearTimeout(t),s>-1){const t=Math.abs(s-e.pageX),r=Math.abs(o-e.pageY);a+=t+r,a>300&&(a=0,this.emoji("p2-1"))}s=e.pageX,o=e.pageY})),this.image.addEventListener("click",(t=>{clearTimeout(e);const a=parseInt(100*Math.random());let s;s=a<70?"p2-2":a<80?"p1-8":a<90?"p2-3":"p2-2-a",this.emoji(s)})),this.image.addEventListener("mousewheel",(t=>{clearTimeout(e),t.preventDefault(),t.wheelDelta>0?this.emoji("p3-1"):this.emoji("p3-5")}),{passive:!1})},parse:e=>e.replace(/:.+:/,(e=>'<img class="single-emoji" data-src="./assets/img/emoji/emoji-'+e.replace(/:/g,"")+'.png">')),log(e,t=3e3,a){this.balloon.innerHTML=this.parse(e),this.balloon.classList.remove("error","success","gray","orange","emoji","blue"),this.balloon.classList.add(a),this.balloon.style.setProperty("display","none");const s=()=>{this.balloon.style.setProperty("animation-duration",t+"ms"),clearTimeout(this.timer),this.timer=setTimeout((()=>{this.balloon.style.setProperty("display","block"),this.timer=setTimeout((()=>{this.balloon.style.setProperty("display","none")}),t)}),33)},o=this.balloon.querySelector("img");if(o){const e=o.getAttribute("data-src");this.loaded_src[e]?(o.src=e,s()):(o.onload=()=>{s(),this.loaded_src[e]=!0},o.src=e)}else s()},emoji(e,t){const a='<img class="single-emoji" data-src="./assets/img/emoji/emoji-'+e+'.png">';this.log(a,t,"emoji")},gray(e,t){this.log(e,t,"gray")},orange(e,t){this.log(e,t,"orange")},blue(e,t){this.log(e,t,"blue")},success(e,t){this.log(e,t,"success")},error(e,t){this.log(e,t,"error")}},ue={current_mapstr:"",undo_stack:[],redo_stack:[],timer:{},reset(){for(this.current_mapstr=he.to_str();this.undo_stack.length;)this.undo_stack.pop();for(;this.redo_stack.length;)this.redo_stack.pop()},redo(){this.redo_stack.length&&(he.open_str(this.redo_stack.pop()),le.log("Redo."),this.push_undo_stack())},undo(){this.undo_stack.length&&(he.open_str(this.undo_stack.pop()),le.log("Undo."),this.push_redo_stack())},push_undo_stack(){clearTimeout(this.timer.push_undo_stack),this.timer.push_undo_stack=setTimeout((()=>{this.undo_stack.push(this.current_mapstr),this.undo_stack.length>100&&this.undo_stack.shift(),le.log("Pushed to undo-stack."),this.current_mapstr=he.to_str()}),50)},push_redo_stack(){this.redo_stack.push(this.current_mapstr),this.redo_stack.length>100&&this.redo_stack.shift(),le.log("Pushed to redo-stack."),this.current_mapstr=he.to_str()},load(e){ie.state_save_data[e]?(pe.success(Te("toaster-success-load-state").replace("{num}",e)),le.log(`Loading state save data [F${e}].`),he.open_str(ie.state_save_data[e])):(pe.error(Te("toaster-success-load-state-error").replace("{num}",e)),le.error(`No state save data [F${e}] exists.`))},save(e){const t=he.to_str();ie.state_save_data[e]=t,le.log(`Saved state save data [F${e}].`),pe.success(Te("toaster-success-save-state").replace("{num}",e))}};class me{constructor(e,t,a){if(this.x=e,this.y=t,this.td=fe("td"),this.td.cell=this,this.resource_elm=fe("div.resource").appendTo(this.td),this.symbol_elm=fe("div.symbol").appendTo(this.td),this.highlight_elm=fe("div.highlight").appendTo(this.td),this.resource_count_elm=fe("p.count").appendTo(this.td),this.life=3,this.land_type=l,this.resource_type=I,this.symbol_type=H,this.rail_dir={from:te,to:te},a){switch(a.land_char){case"a":this.land_type=i;break;case"b":this.land_type=l;break;case"c":this.land_type=g;break;case"d":this.land_type=b;break;case"e":this.land_type=y;break;case"f":this.land_type=p;break;case"g":this.land_type=p,this.life=2;break;case"h":this.land_type=p,this.life=1;break;case"i":this.land_type=p,this.life=0;break;case"j":this.land_type=p,this.life=0,this.resource_type=P;break;case"k":this.land_type=d;break;case"l":this.land_type=d,this.life=2;break;case"m":this.land_type=d,this.life=1;break;case"n":this.land_type=d,this.life=0;break;case"o":this.land_type=d,this.life=0,this.resource_type=$;break;case"p":this.land_type=u;break;case"q":this.land_type=c;break;case"r":this.land_type=m;break;case"s":this.land_type=_;break;case"t":this.land_type=h;break;case"u":this.land_type=f.replace("1",a.land_num)}switch(a.resource_char){case"A":this._resource_type=S,this.td.setAttribute("resource-type",S),this.rail_dir={from:3,to:1},this.update_rail();break;case"B":this._resource_type=S,this.td.setAttribute("resource-type",S),this.rail_dir={from:0,to:2},this.update_rail();break;case"C":this._resource_type=S,this.td.setAttribute("resource-type",S),this.rail_dir={from:0,to:1},this.update_rail();break;case"D":this._resource_type=S,this.td.setAttribute("resource-type",S),this.rail_dir={from:1,to:2},this.update_rail();break;case"E":this._resource_type=S,this.td.setAttribute("resource-type",S),this.rail_dir={from:2,to:3},this.update_rail();break;case"F":this._resource_type=S,this.td.setAttribute("resource-type",S),this.rail_dir={from:0,to:3},this.update_rail();break;case"G":this._resource_type=C,this.td.setAttribute("resource-type",C),this.rail_dir={from:3,to:1},this.update_rail(),a.resource_count&&(this.resource_count=a.resource_count);break;case"H":this._resource_type=C,this.td.setAttribute("resource-type",C),this.rail_dir={from:0,to:2},this.update_rail(),a.resource_count&&(this.resource_count=a.resource_count);break;case"I":this._resource_type=C,this.td.setAttribute("resource-type",C),this.rail_dir={from:0,to:1},this.update_rail(),a.resource_count&&(this.resource_count=a.resource_count);break;case"J":this._resource_type=C,this.td.setAttribute("resource-type",C),this.rail_dir={from:1,to:2},this.update_rail(),a.resource_count&&(this.resource_count=a.resource_count);break;case"K":this._resource_type=C,this.td.setAttribute("resource-type",C),this.rail_dir={from:2,to:3},this.update_rail(),a.resource_count&&(this.resource_count=a.resource_count);break;case"L":this._resource_type=C,this.td.setAttribute("resource-type",C),this.rail_dir={from:0,to:3},this.update_rail(),a.resource_count&&(this.resource_count=a.resource_count);break;case"M":this.resource_type=P,a.resource_count&&(this.resource_count=a.resource_count);break;case"N":this.resource_type=$,a.resource_count&&(this.resource_count=a.resource_count);break;case"O":this.resource_type=D;break;case"P":this.resource_type=B;break;case"Q":this.resource_type=z;break;case"R":this.resource_type=O;break;case"S":this.resource_type=W.replace("1",a.resource_count||1);break;case"T":this._resource_type=j,this.td.setAttribute("resource-type",j),this.td.setAttribute("face-id",a.resource_count),this.td.style.setProperty("--face-image","url(../img/face/face-"+a.resource_count+".png)");break;case"U":this._resource_type=U,this.td.setAttribute("resource-type",U),this.td.setAttribute("symbol-id",a.resource_count),this.td.style.setProperty("--symbol-image","url(../img/symbol/"+a.resource_count+".png)");break;case"V":this.resource_type=R}switch(a.symbol_char){case"X":this._symbol_type=q,this.td.setAttribute("symbol-type",q),this.td.setAttribute("symbol-id",a.symbol_id),this.td.style.setProperty("--symbol-image","url(../img/symbol/"+a.symbol_id+".png)");break;case"Y":this._symbol_type=F,this.td.setAttribute("symbol-type",F),this.td.setAttribute("face-id",a.symbol_id),this.td.style.setProperty("--face-image","url(../img/face/face-"+a.symbol_id+".png)")}}this.set_event()}set_event(){this.td.oncontextmenu=()=>!1,this.td.addEventListener("mousedown",(e=>{if(0===e.button){switch(ie.mouse_state.current_palette_type){case G:case J:case K:case V:ie.key_state.Control?ie.mouse_state.current_palette_type===G&&(ve(this.x,this.y,ie.mouse_state.current_palette_item,this.land_type),he.onchange()):ie.key_state.Shift||ie.key_state.Alt?(ie.route_highlight_cells.forEach((e=>{e.apply_palette()})),de.reset(),he.onchange()):this.apply_palette();break;case Z:ce.put(this),he.onchange()}ie.mouse_state.last_put_cell=this,ie.mouse_state.last_move_cell=this,ie.mouse_state.changed=!0}else if(2===e.button){if(this.land_type.includes("color")){const e=document.querySelector(`[land-type=${f}]`);e.trigger("click"),e.style.setProperty("background-image",`url(./assets/img/color/${this.land_type.replace("color-","")}.png)`)}else document.querySelector(`[land-type=${this.land_type}]`).trigger("click");le.log(this)}}),{passive:!1}),this.td.addEventListener("mouseenter",(e=>{const t=ie.mouse_state.last_move_cell;if(ie.mouse_state.last_move_cell=this,ie.mouse_state.is_down){switch(ie.mouse_state.current_palette_type){case G:case J:case K:case V:const e=xe(t,ie.mouse_state.last_move_cell);if(e&&e.length){for(let t=1;t<e.length;t++)e[t].apply_palette(!0);ie.mouse_state.changed=!0,ie.mouse_state.last_put_cell=this}break;case Z:ce.put(this),ie.mouse_state.changed=!0,ie.mouse_state.last_put_cell=this}de.mouse()}else if(ie.mouse_state.current_palette_type===K&&ie.mouse_state.current_palette_item===Y){const e=parseInt(document.getElementById("mine-dynamite").getAttribute("dynamite-level"));de.dynamite(e)}else ie.key_state.Shift?de.route(!1):ie.key_state.Alt?de.route(!0):de.mouse()})),this.td.addEventListener("mousewheel",(e=>{e.preventDefault();const t=this.resource_type;if(t===C||t===P||t===$){let t,a=this.resource_count;t=e.wheelDelta>0?Math.max(1,Math.min(99,a+1)):Math.max(1,Math.min(99,a-1)),a!==t&&(this.resource_count=t,ue.push_undo_stack())}}),{passive:!1})}apply_palette(e){switch(ie.mouse_state.current_palette_type){case G:if(this.land_type=ie.mouse_state.current_palette_item,this.life=3,this.is_vacant()||(this.resource_type=I),ie.mouse_state.current_palette_item===g){const e=this.right();e&&(e.land_type=b)}break;case J:e?this.resource_type!==ie.mouse_state.current_palette_item&&(this.resource_type=ie.mouse_state.current_palette_item):this.resource_type=ie.mouse_state.current_palette_item;break;case V:this.symbol_type=ie.mouse_state.current_palette_item;break;case K:switch(ie.mouse_state.current_palette_item){case X:this.mine(3);break;case Y:const e=parseInt(document.getElementById("mine-dynamite").getAttribute("dynamite-level"));this.mine_with_dynamite(e)}}he.onchange()}mine(e){e&&(this.land_type===p&&this.life>0&&(this.life=Math.max(0,this.life-e),0===this.life&&(this.resource_type=P)),this.land_type===d&&this.life>0&&(this.life=Math.max(0,this.life-e),0===this.life&&(this.resource_type=$)))}mine_with_dynamite(e){const t=we(this,e);t&&t.length&&t.forEach((e=>{e.cell.mine(e.power)}))}is_vacant(){let e=!1;switch(this.land_type){case l:case f:case k:case v:case w:case x:case L:case A:case T:case E:case M:case m:e=!0}return e}get life(){return this._life}set life(e){this.td.setAttribute("life",e),this._life=e}update_rail(){if(this.resource_type===S)if(this.rail_dir.to<0)0===this.rail_dir.from||2===this.rail_dir.from?this.td.setAttribute("rail-direction","tb"):this.td.setAttribute("rail-direction","rl");else{const e=[this.rail_dir.from,this.rail_dir.to].sort(),t=["t","r","b","l"],a=`${t[e[0]]}${t[e[1]]}`;this.td.setAttribute("rail-direction",a)}}get land_type(){return this._land_type}set land_type(e){this._land_type=e,this.td.setAttribute("land-type",e)}checkNextConnectionAround(e){let t=!1;for(let a=0;a<ee.length;a++){if(a===e)continue;const s=ke(a);let o=this.x+ee[a][0],r=this.y+ee[a][1];if(he.is_on_map(o,r)){let e=ie.map_cell[r][o];if(e.check_end_of_rail()||e.resource_type===C&&1===e.resource_count){this.rail_dir[this.get_free_dir()]=a,this.update_rail(),e.rail_dir[e.get_free_dir()]=s,e._resource_type=S,e.td.setAttribute("resource-type",S),e.update_rail(),e.checkNextConnectionOne(),t=!0;break}}}return t}checkNextConnectionOne(){const e=this.rail_dir.to>-1?this.rail_dir.to:ke(this.rail_dir.from),t=ke(e),a=this.x+ee[e][0],s=this.y+ee[e][1];if(he.is_on_map(a,s)){const e=ie.map_cell[s][a];e.resource_type===C&&1===e.resource_count&&e.rail_dir.from===t&&(e._resource_type=S,e.td.setAttribute("resource-type",S),e.checkNextConnectionOne())}}connectToEndOfRail(){let e=!1;for(let t=0;t<ee.length;t++){const a=ke(t);let s=this.x+ee[t][0],o=this.y+ee[t][1];if(he.is_on_map(s,o)){let r=ie.map_cell[o][s];if(r.check_end_of_rail()){const s=r.get_free_dir(),o="from"===s?"to":"from";r.rail_dir[s]=a,r.is_flexible&&(r.rail_dir[o]=t,r.is_flexible=!1),r.update_rail(),this.rail_dir[this.get_free_dir(t)]=t,this.update_rail(),this.checkNextConnectionAround(t),e=!0;break}}}return e}get symbol_type(){return this._symbol_type}set symbol_type(e){switch(e){case Q:this._symbol_type=H,this.td.setAttribute("symbol-type",e);break;case q:this._symbol_type=e,this.td.setAttribute("symbol-type",e);const t=document.getElementById("palette-symbol").getAttribute("symbol-id");this.td.setAttribute("symbol-id",t),this.td.style.setProperty("--symbol-image","url(../img/symbol/"+t+".png)");break;case F:this._symbol_type=e,this.td.setAttribute("symbol-type",e);const a=document.getElementById("palette-symbol-face").getAttribute("face-id");this.td.setAttribute("face-id",a),this.td.style.setProperty("--face-image","url(../img/face/face-"+a+".png)")}}get resource_type(){return this._resource_type}set resource_type(e){switch(e){case N:this._resource_type=I,this.resource_count=0,this.td.setAttribute("resource-type",e);break;case S:this._resource_type!==S&&(this._resource_type=e,this.resource_count=1,this.rail_dir={from:te,to:te},this.td.setAttribute("rail-direction","rl"),this.td.setAttribute("resource-type",e),this.connectToEndOfRail()||(this.is_flexible=!0,this.update_rail()));break;default:if(this._resource_type!==e||e===j||e===U){if(this._resource_type=e,this.resource_count=1,this.rail_dir={from:te,to:te},this.td.setAttribute("resource-type",e),e.includes("dynamite")){const t=parseInt(e.split("-")[1]);this.td.setAttribute("level",t)}if(e===j){const e=document.getElementById("palette-face").getAttribute("face-id");this.td.setAttribute("face-id",e),this.td.style.setProperty("--face-image","url(../img/face/face-"+e+".png)")}if(e===U){const e=document.getElementById("palette-symbol").getAttribute("symbol-id");this.td.setAttribute("symbol-id",e),this.td.style.setProperty("--symbol-image","url(../img/symbol/"+e+".png)")}e===C&&(this.rail_dir={from:3,to:1},this.update_rail())}else e!==C&&e!==P&&e!==$||(this.resource_count+=1)}}get resource_count(){return this._resource_count}set resource_count(e){this._resource_count=e,this.resource_count_elm.textContent=e,e>1?this.resource_count_elm.style.setProperty("display","block"):this.resource_count_elm.style.setProperty("display","none")}check_end_of_rail(){if(this.resource_type===S){const e=this.get_cell_with_dir(this.rail_dir.from),t=this.get_cell_with_dir(this.rail_dir.to);return!(e&&t&&this.is_connect_to(e)&&this.is_connect_to(t))}return!1}get_cell_with_dir(e){if(e<0)return null;const t=ee[e],a=this.x+t[0],s=this.y+t[1];return he.is_on_map(a,s)?ie.map_cell[s][a]:null}is_connect_to(e){if(!e)return!1;const t=this.get_cell_with_dir(this.rail_dir.to),a=this.get_cell_with_dir(this.rail_dir.from),s=e.get_cell_with_dir(e.rail_dir.to),o=e.get_cell_with_dir(e.rail_dir.from);return!(t!==e&&a!==e||s!==this&&o!==this)}get_free_dir(e=-1){if(e<0){const e=this.get_cell_with_dir(this.rail_dir.to);return this.is_connect_to(e)?"from":"to"}return this.rail_dir.from!==e?"from":"to"}get_next_cell(e){if(e<0||isNaN(e))return null;const t=ee[e],a=this.x+t[0],s=this.y+t[1];return he.is_on_map(a,s)?ie.map_cell[s][a]:null}get_next_rail(e){if("string"==typeof e){const t=this.rail_dir[e],a=this.get_next_cell(t);return a&&a.resource_type===S?a:null}{const t=this.get_next_cell(this.rail_dir.from),a=this.get_next_cell(this.rail_dir.to);return t===e?a:t}}right(){const e=this.x+1,t=this.y;return he.is_on_map(e,t)?ie.map_cell[t][e]:null}}const _e={init(){confirm("ローカルストレージを初期化します。よろしいですか？")&&localStorage.removeItem("Unrailed-Map-Maker")},save(){const e=JSON.stringify(ie.save_data);localStorage.setItem("Unrailed-Map-Maker",e)},load(){const e=localStorage.getItem("Unrailed-Map-Maker");if(e){const t=JSON.parse(e);Object.keys(t).forEach((e=>{ie.save_data[e]=t[e]}))}}},he={forEachCell(e){for(let t=0;t<this.height();t++)for(let a=0;a<this.width();a++)e(ie.map_cell[t][a])},forEachY(e){for(let t=0,a=this.height();t<a;t++)e(t)},forEachX(e){for(let t=0,a=this.width();t<a;t++)e(t)},height:()=>ie.map_cell.length,width:()=>ie.map_cell[0].length,change_map_size(){const e=parseInt(be(".map-size-container[dir=x] input").value),t=parseInt(be(".map-size-container[dir=y] input").value),a=this.width(),s=this.height(),o=Math.abs(e-a),r=Math.abs(t-s);if(e>a)for(let e=0;e<s;e++)for(let t=0;t<o;t++){const s=a+t,o=new me(s,e,null);ie.map_elm.tr[e].append(o.td),ie.map_elm.td[e][s]=o.td,ie.map_cell[e][s]=o}else if(e<a)for(let e=0;e<s;e++)for(let t=o-1;t>=0;t--)ie.map_elm.td[e].pop().remove(),ie.map_cell[e].pop();if(t>s)for(let t=0;t<r;t++){const a=s+t,o=fe("tr");ie.map_elm.tr[a]=o,ie.map_elm.td[a]=[],ie.map_cell[a]=[];for(let t=0;t<e;t++){const e=new me(t,a,null);ie.map_cell[a][t]=e,ie.map_elm.td[a][t]=e.td,o.append(e.td)}ie.map_elm.table.append(o)}else if(t<s)for(let t=0;t<r;t++){const a=s-t-1;for(let t=0;t<e;t++)ie.map_elm.td[a].pop().remove(),ie.map_cell[a].pop();ie.map_elm.tr.pop().remove(),ie.map_elm.td.pop(),ie.map_cell.pop()}this.onchange()},change_map_size_one(e,t){const a=t?"_plus":"_minus";this.change_map_size_func[e+a].call(this)},change_map_size_func:{right_plus(){const e=this.width();this.forEachY((t=>{const a=new me(e,t,null);ie.map_elm.tr[t].append(a.td),ie.map_elm.td[t][e]=a.td,ie.map_cell[t][e]=a}))},right_minus(){this.forEachY((e=>{ie.map_elm.td[e].pop().remove(),ie.map_cell[e].pop()}))},left_plus(){this.forEachCell((e=>{e.x+=1})),this.forEachY((e=>{const t=new me(0,e,null);ie.map_elm.tr[e].prepend(t.td),ie.map_elm.td[e].unshift(t.td),ie.map_cell[e].unshift(t)}))},left_minus(){this.forEachCell((e=>{e.x-=1})),this.forEachY((e=>{new me(0,e,null),ie.map_elm.td[e].shift().remove(),ie.map_cell[e].shift()}))},bottom_plus(){const e=this.height(),t=fe("tr");ie.map_elm.tr[e]=t,ie.map_elm.td[e]=[],ie.map_cell[e]=[],this.forEachX((a=>{const s=new me(a,e,null);ie.map_cell[e][a]=s,ie.map_elm.td[e][a]=s.td,t.append(s.td)})),ie.map_elm.table.append(t)},bottom_minus(){const e=this.height()-1;this.forEachX((t=>{ie.map_elm.td[e].pop().remove(),ie.map_cell[e].pop()})),ie.map_elm.tr.pop().remove(),ie.map_elm.td.pop(),ie.map_cell.pop()},top_plus(){this.forEachCell((e=>{e.y+=1}));const e=fe("tr");ie.map_elm.tr.unshift(e),ie.map_elm.td.unshift([]);const t=[];this.forEachX((e=>{t.push(null)})),ie.map_cell.unshift(t),this.forEachX((t=>{const a=new me(t,0,null);ie.map_cell[0][t]=a,ie.map_elm.td[0][t]=a.td,e.append(a.td)})),ie.map_elm.table.prepend(e)},top_minus(){this.forEachCell((e=>{e.y-=1})),this.forEachX((e=>{ie.map_elm.td[0].shift().remove(),ie.map_cell[0].shift()})),ie.map_elm.tr.shift().remove(),ie.map_elm.td.shift(),ie.map_cell.shift()}},download_as_image(){const e="Map-"+(a=(t=new Date).getFullYear(),s=t.getMonth()+1,o=t.getDate(),r=t.getHours(),n=t.getMinutes(),i=t.getSeconds(),a+"-"+("00"+s).slice(-2)+"-"+("00"+o).slice(-2)+"-"+("00"+r).slice(-2)+"-"+("00"+n).slice(-2)+"-"+("00"+i).slice(-2));var t,a,s,o,r,n,i;this.to_canvas((t=>{const a=fe("a");a.href=t.toDataURL("image/png"),a.download=e+".png",a.click(),le.log("Downloaded the image!")}))},to_canvas(e){try{const s=ie.map_cell[0].length,o=ie.map_cell.length,r=64,n=fe("canvas"),i=n.getContext("2d");n.width=s*r,n.height=o*r,i.font='bold 90px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu,Cantarell, "Helvetica Neue", Arial,"Hiragino Kaku Gothic ProN", "Hiragino Sans", "BIZ UDPGothic", Meiryo, sans-serif',i.textAlign="left",i.textBaseline="top";let l=0,c=0;const d=location.href.split("?")[0];function t(e){if(e&&"none"!==e&&!(e in ie.image_cache)){ie.image_cache[e]="loading",l++;const t=new Image;t.onload=()=>{ie.image_cache[e]=t,c++,c===l&&a()},setTimeout((()=>{t.src=function(e){return(e=e.replace(/url\(|['")]/g,"")).replace("../img","./assets/img"),e.replace(d,"./")}(e)}),10)}}for(let e=0;e<ie.map_cell.length;e++)for(let a=0;a<ie.map_cell[0].length;a++){const s=ie.map_cell[e][a],o=window.getComputedStyle(s.td),r=window.getComputedStyle(s.resource_elm),n=window.getComputedStyle(s.symbol_elm);t(o["background-image"]),t(r["background-image"]),t(n["background-image"])}function a(){for(let e=0;e<ie.map_cell.length;e++)for(let t=0;t<ie.map_cell[0].length;t++){const a=ie.map_cell[e][t],s=window.getComputedStyle(a.td),o=window.getComputedStyle(a.resource_elm),n=window.getComputedStyle(a.resource_count_elm),l=window.getComputedStyle(a.symbol_elm),c=ie.image_cache[s["background-image"]],d=ie.image_cache[o["background-image"]],p=ie.image_cache[l["background-image"]],u=t*r,m=e*r;i.fillStyle=s["background-color"],i.fillRect(u,m,r,r),c&&i.drawImage(c,u,m,r,r),d&&i.drawImage(d,u,m,r,r),p&&i.drawImage(p,u,m,r,r),"block"===n.display&&(i.fillStyle="#000",i.font=`bold ${Math.ceil(.45*r)}px ${n["font-family"]}`,i.textAlign="left",i.textBaseline="top",i.strokeStyle="#fff",i.lineWidth=Math.ceil(.08*r),i.lineJoin="round",["strokeText","fillText"].forEach((e=>{i[e](a.resource_count_elm.textContent,u,m)})))}if(ce.elm.container){const e=fe("canvas"),t=e.getContext("2d");e.width=s*r,e.height=o*r;const a=window.getComputedStyle(ce.elm.engine),n=ie.image_cache[a["background-image"]],l=parseFloat(ce.elm.engine.css("left"))*r/32,c=parseFloat(ce.elm.engine.css("top"))*r/32,d=parseFloat(ce.elm.engine.css("--rotate"));t.save(),t.translate(l,c),t.rotate(d*Math.PI/180),t.drawImage(n,-r,.5*-r,2*r,r),t.restore(),ce.elm.wagons.forEach((e=>{const a=window.getComputedStyle(e),s=ie.image_cache[a["background-image"]],o=parseFloat(e.css("left"))*r/32,n=parseFloat(e.css("top"))*r/32,i=parseFloat(e.css("--rotate"));t.save(),t.translate(o,n),t.rotate(i*Math.PI/180),t.drawImage(s,.75*-r,.5*-r,1.5*r,r),t.restore()})),i.shadowOffsetX=7*r/32,i.shadowOffsetY=7*r/32,i.shadowColor="rgba(0, 0, 0, .5)",i.shadowBlur=1*r/32,i.drawImage(e,0,0)}e(n)}ce.elm.container&&(t(window.getComputedStyle(ce.elm.engine)["background-image"]),ce.elm.wagons.forEach((e=>{t(window.getComputedStyle(e)["background-image"])}))),0===l&&a()}catch(e){le.error("Failed to create the canvas."),console.error(e)}},open_str(e){const i=decodeURIComponent(e).inflate()+"a";let l,c,d=t,p=40,u=20,m="",_="";for(c=0;c<i.length;c++){const e=i.charAt(c);let l;switch(e){case"b":case"w":case"h":case"t":case"m":l=e;break;default:m+=e}if(l){if(m){const e=parseInt(m);switch(m="",_){case"b":d=[t,a,s,o,r,n][e-1];break;case"w":p=e;break;case"h":u=e}}_=l}if("t"===_||"m"===_){c++;break}}if("t"===_){const e=c;for(;c<i.length&&"-"!==i.charAt(c);c++);const t=i.substr(e,c-e).split(",");l={x:parseInt(t[0]),y:parseInt(t[1]),a:parseFloat(t[2]),d:parseInt(t[3]),w:ce.decode(t[4])},c+=2}let h=[],g={},b="";for(;c<i.length;c++){const e=i.charAt(c);e.match(/[a-z]/)?(g.land_char&&(b&&(g.symbol_char?(g.symbol_id=parseInt(b),b=""):g.resource_char?(g.resource_count=parseInt(b),b=""):(g.land_num=parseInt(b),b="")),h.push(g)),g={land_char:e}):e.match(/[A-W]/)?(b&&(g.land_num=parseInt(b),b=""),g.resource_char=e):e.match(/[X-Z]/)?(b&&(g.resource_char?(g.resource_count=parseInt(b),b=""):(g.land_num=parseInt(b),b="")),g.symbol_char=e):e.match(/[0-9]/)&&(b+=e)}this.make_table(d,p,u,h,l)},make_table(e,t,a,s,o){ie.is_autosave_enabled=!1,ie.map_wrapper.innerHTML="",ce.remove();const r=fe("table#map-table");ie.map_cell=[],ie.map_elm={table:r,tr:[],td:[]},be(".map-size-container[dir=x] input").value=t,be(".map-size-container[dir=y] input").value=a;for(let e=0,o=0;o<a;o++){const a=fe("tr");ie.map_cell[o]=[],ie.map_elm.tr[o]=a,ie.map_elm.td[o]=[];for(let r=0;r<t;r++){const t=s?s[e]:null,n=new me(r,o,t);ie.map_cell[o][r]=n,ie.map_elm.td[o][r]=n.td,a.append(n.td),e++}r.append(a)}if(r.addEventListener("mousedown",(e=>{ie.mouse_state.is_down=!0})),r.addEventListener("mousemove",(e=>{})),r.addEventListener("mouseup",(e=>{ie.mouse_state.changed&&ue.push_undo_stack(),ie.mouse_state.is_down=!1,ie.mouse_state.changed=!1})),r.addEventListener("mouseleave",(e=>{de.reset()})),ie.map_wrapper.append(r),this.count(),o){const e=ie.map_cell[o.y][o.x],t=o.d===e.rail_dir.from?"from":"to";ce.wagon_names=o.w,ce.put(e,t,o.a)}ie.is_autosave_enabled=!0},to_str(){let e="";if(ie.map_biome!==t)switch(e+="b",ie.map_biome){case t:e+="1";break;case a:e+="2";break;case s:e+="3";break;case o:e+="4";break;case r:e+="5";break;case n:e+="6"}40!==ie.map_cell[0].length&&(e+="w",e+=ie.map_cell[0].length),20!==ie.map_cell.length&&(e+="h",e+=ie.map_cell.length),ce.elm.container&&(e+="t",e+=`${ce.root_cell.x},${ce.root_cell.y},${ce.alpha},${ce.root_cell.rail_dir[ce.dir]},${ce.encode(ce.wagon_names)}-`),e+="m";for(let t=0;t<ie.map_cell.length;t++)for(let a=0;a<ie.map_cell[0].length;a++){const s=ie.map_cell[t][a];let o="";switch(s.land_type){case i:o+="a";break;case l:o+="b";break;case g:o+="c";break;case b:o+="d";break;case y:o+="e";break;case p:switch(s.life){case 3:o+="f";break;case 2:o+="g";break;case 1:o+="h";break;case 0:s.resource_type===P&&1===s.resource_count?o+="j":o+="i"}break;case d:switch(s.life){case 3:o+="k";break;case 2:o+="l";break;case 1:o+="m";break;case 0:s.resource_type===$&&1===s.resource_count?o+="o":o+="n"}break;case u:o+="p";break;case c:o+="q";break;case m:o+="r";break;case _:o+="s";break;case h:o+="t";break;case f:o+="u1";break;case k:o+="u2";break;case v:o+="u3";break;case w:o+="u4";break;case x:o+="u5";break;case L:o+="u6";break;case A:o+="u7";break;case T:o+="u8";break;case E:o+="u9";break;case M:o+="u10"}switch(s.resource_type){case S:switch(s.td.getAttribute("rail-direction")){default:case"rl":o+="A";break;case"tb":o+="B";break;case"tr":o+="C";break;case"rb":o+="D";break;case"bl":o+="E";break;case"tl":o+="F"}break;case C:switch(s.td.getAttribute("rail-direction")){default:case"rl":o+="G";break;case"tb":o+="H";break;case"tr":o+="I";break;case"rb":o+="J";break;case"bl":o+="K";break;case"tl":o+="L"}s.resource_count>1&&(o+=s.resource_count);break;case P:"j"!==o&&(o+="M",s.resource_count>1&&(o+=s.resource_count));break;case $:"o"!==o&&(o+="N",s.resource_count>1&&(o+=s.resource_count));break;case W:o+="S";break;case"resource-dynamite-2":o+="S2";break;case"resource-dynamite-3":o+="S3";break;case"resource-dynamite-4":o+="S4";break;case"resource-dynamite-5":o+="S5";break;case"resource-dynamite-6":o+="S6";break;case"resource-dynamite-7":o+="S7";break;case"resource-dynamite-8":o+="S8";break;case"resource-dynamite-9":o+="S9";break;case D:o+="O";break;case B:o+="P";break;case z:o+="Q";break;case O:o+="R";break;case j:o+="T"+s.td.getAttribute("face-id");break;case U:o+="U"+s.td.getAttribute("symbol-id");break;case R:o+="V"}switch(s.symbol_type){default:break;case q:o+="X"+s.td.getAttribute("symbol-id");break;case F:o+="Y"+s.td.getAttribute("face-id")}e+=o}return encodeURIComponent(e.deflate())},onchange(){clearTimeout(ie.autosave_timer),ie.autosave_timer=setTimeout((()=>{const e=this.to_str(),t=parseInt((new Date).getTime()/1e3);ie.is_autosave_enabled&&(ie.save_data.file.autosave={id:"autosave",title:"Auto-saved data",created:"autosave",modified:t,data:e},ie.save_data.last_file_key="autosave",_e.save(),le.log("Auto-saved.")),ie.is_saved=!1}),1e3),clearTimeout(ie.autosave_timer_sub),ie.autosave_timer_sub=setTimeout((()=>{this.count()}),40)},count(){const e={wood:0,iron:0,"r-wood":0,"r-iron":0,"c-rail":0,"r-rail":0,bridge:0},t=[];function a(e){for(let a=0;a<t.length;a++){const s=t[a],o=s.y+1,r=s.x+0,n=s.x+1,i=s.x+2;if(e.y===o&&(e.x===r||e.x===n||e.x===i))return!0}return!1}for(let s=0;s<ie.map_cell.length;s++)for(let o=0;o<ie.map_cell[s].length;o++){const r=ie.map_cell[s][o];let n=1;switch(r.land_type){case p:e.wood++;break;case d:e.iron++;break;case m:e.bridge++;break;case g:t.push(r)}switch(r.resource_type){case P:n=r.resource_count||1,e["r-wood"]+=n;break;case $:n=r.resource_count||1,e["r-iron"]+=n;break;case C:a(r)||(n=r.resource_count||1,e["r-rail"]+=n);break;case S:a(r)||e["c-rail"]++}}Object.keys(e).forEach((t=>{ie.count_elm[t].textContent=e[t]}))},create_new(){let e=!0;ie.current_file_key&&!ie.is_saved&&(e=confirm(Te("confirm-new"))),e&&(he.make_table(t,40,20,!1),ie.current_file_key=null,ie.save_data.last_file_key=null,be("#file-name").classList.remove("enabled"),be("#file-save").classList.remove("enabled"),pe.success(Te("toaster-success-new")),le.hr(),le.log("New created."),le.hr(),ue.reset())},is_on_map(e,t){return e>=0&&t>=0&&t<this.height()&&e<this.width()}};function ge(e){const t=String(e||window.location),a=t.slice(t.indexOf("?")+1),s={};return a?(a.split("&").forEach((e=>{const t=e.split("=");s[t[0]]=t[1]})),s):s}function be(e){return document.body.querySelector(e)}function ye(e){return document.body.querySelectorAll(e)}function fe(e,t){let a;const s=[],o=[];let r=e.split("[");if(r.length>1)for(let e=1;e<r.length;e++)s.push(r[e].split("]")[0].split("="));if(r=r[0].split("."),r.length>1)for(let e=1;e<r.length;e++)o.push(r[e]);r=r[0].split("#"),r.length>1&&(a=r[1]);const n=r[0],i=document.createElement(n);return a&&i.setAttribute("id",a),o.forEach((e=>{i.classList.add(e)})),s.forEach((e=>{i.setAttribute(e[0],e[1])})),t&&("string"==typeof t?i.textContent=t:i.append(t)),i}function ke(e){return(e+2)%4}function ve(e,t,a,s,o=0){0===o&&ie.map_cell[t][e].land_type===a||ie.map_cell[t][e].land_type===s&&(ie.map_cell[t][e].land_type=a,t>0&&ve(e,t-1,a,s,o+1),t+1<ie.map_cell.length&&ve(e,t+1,a,s,o+1),e+1<ie.map_cell[0].length&&ve(e+1,t,a,s,o+1),e>0&&ve(e-1,t,a,s,o+1))}function we(e,t){const a=[];t=Math.max(1,Math.min(9,t));const s=re[t-1],o=s[0].length,r=parseInt((o-1)/2);for(let t=0;t<o;t++)for(let n=0;n<o;n++){const o=s[t][n],i=e.x-r+n,l=e.y-r+t;if(he.is_on_map(i,l)){const e=ie.map_cell[l][i];a.push({cell:e,power:o})}}return a}function xe(e,t){const a=e.x,s=e.y,o=t.x-e.x,r=t.y-e.y,n=Math.abs(o),i=Math.abs(r),l=Math.sign(o),c=Math.sign(r),d=r/o,p=[];for(let e=0;e<i;e++){const t=c*(e+.5),a=Math.floor(Math.abs(t/d+.5*l));p.push(a)}const u=[];for(let e=0,t=0;e<=n;e++){const o=ie.map_cell[s+c*t][a+l*e];for(u.push(o);p.length&&p[0]===e;){t++;const o=ie.map_cell[s+c*t][a+l*e];u.push(o),p.shift()}}return u}function Le(e,t){let a=0;ee.forEach((t=>{const s=e.x+t[0],o=e.y+t[1];he.is_on_map(s,o)&&ie.map_cell[o][s].land_type===u&&(a+=.1)})),ee.forEach((s=>{const o=e.x+s[0],r=e.y+s[1];if(he.is_on_map(o,r)){const s=ie.map_cell[r][o];if(s.land_type!==u&&s.resource_type!==S){const o=e.explore_data.score-1+a;o>s.explore_data.score&&(s.explore_data.score=o,s.explore_data.from=e,s.explore_data.is_end||Le(s,t+1))}}}))}function Ae(e){const t=new Date(1e3*e);return`${t.getFullYear()}/${t.getMonth()+1}/${t.getDate()} ${t.getHours()}:${t.getMinutes().padding(2)}:${t.getSeconds().padding(2)}`}function Te(e){return ne[e]?ne[e][ie.lang_key]:(console.error(e+" is undefined."),"")}function Ee(e){return"from"===e?"to":"from"}const Me={linearTween:(e,t,a,s)=>a*e/s+t,easeInQuad:(e,t,a,s)=>a*(e/=s)*e+t,easeOutQuad:(e,t,a,s)=>-a*(e/=s)*(e-2)+t,easeInOutQuad:(e,t,a,s)=>(e/=s/2)<1?a/2*e*e+t:-a/2*((e-=1)*(e-2)-1)+t,easeInCubic:(e,t,a,s)=>a*(e/=s)*e*e+t,easeOutCubic:(e,t,a,s)=>(e/=s,a*((e-=1)*e*e+1)+t),easeInOutCubic:(e,t,a,s)=>(e/=s/2)<1?a/2*e*e*e+t:a/2*((e-=2)*e*e+2)+t,easeInQuart:(e,t,a,s)=>a*(e/=s)*e*e*e+t,easeOutQuart:(e,t,a,s)=>(e/=s,-a*((e-=1)*e*e*e-1)+t),easeInOutQuart:(e,t,a,s)=>(e/=s/2)<1?a/2*e*e*e*e+t:-a/2*((e-=2)*e*e*e-2)+t,easeInQuint:(e,t,a,s)=>a*(e/=s)*e*e*e*e+t,easeOutQuint:(e,t,a,s)=>(e/=s,a*((e-=1)*e*e*e*e+1)+t),easeInOutQuint:(e,t,a,s)=>(e/=s/2)<1?a/2*e*e*e*e*e+t:a/2*((e-=2)*e*e*e*e+2)+t,easeInSine:(e,t,a,s)=>-a*Math.cos(e/s*(Math.PI/2))+a+t,easeOutSine:(e,t,a,s)=>a*Math.sin(e/s*(Math.PI/2))+t,easeInOutSine:(e,t,a,s)=>-a/2*(Math.cos(Math.PI*e/s)-1)+t,easeInExpo:(e,t,a,s)=>a*Math.pow(2,10*(e/s-1))+t,easeOutExpo:(e,t,a,s)=>a*(1-Math.pow(2,-10*e/s))+t,easeInOutExpo:(e,t,a,s)=>(e/=s/2)<1?a/2*Math.pow(2,10*(e-1))+t:(e-=1,a/2*(2-Math.pow(2,-10*e))+t),easeInCirc:(e,t,a,s)=>(e/=s,-a*(Math.sqrt(1-e*e)-1)+t),easeOutCirc:(e,t,a,s)=>(e/=s,e-=1,a*Math.sqrt(1-e*e)+t),easeInOutCirc:(e,t,a,s)=>(e/=s/2)<1?-a/2*(Math.sqrt(1-e*e)-1)+t:(e-=2,a/2*(Math.sqrt(1-e*e)+1)+t)},Ie={load(e){const t=ie.save_data.file[e];t&&(he.open_str(t.data),"autosave"!==e?(ie.current_file_key=t.created,ie.save_data.last_file_key=t.created,be("#file-name").val(t.title).classList.add("enabled"),be("#file-save").classList.add("enabled")):(ie.current_file_key=null,ie.save_data.last_file_key="autosave",be("#file-name").val(t.title).classList.remove("enabled"),be("#file-save").classList.remove("enabled")),ue.reset(),_e.save())},save(){if(ie.current_file_key){const e=be("#file-name").value,t=parseInt((new Date).getTime()/1e3);ie.save_data.file[ie.current_file_key]={title:e,created:ie.current_file_key,modified:t,data:he.to_str()},ie.is_saved=!0,ie.save_data.last_file_key=ie.current_file_key,_e.save()}},save_as(e){const t=parseInt((new Date).getTime()/1e3);ie.save_data.file[t]={title:e,created:t,modified:t,data:he.to_str()},ie.save_data.last_file_key=t,_e.save(),ie.current_file_key=t,ie.is_saved=!0,be("#file-name").val(e).classList.add("enabled"),be("#file-save").classList.add("enabled")}};(()=>{const a={close(e){ie.main_window.classList.remove("blur"),ie.modal_window.classList.add("hidden"),ie.modal_window.innerHTML=""},open(e){this.open_func[e].call(this)},open_func:{common(e){ie.main_window.classList.add("blur"),ie.modal_window.classList.remove("hidden");const t=fe("div.modal-container");e.classname&&t.classList.add(e.classname),t.on("click",(e=>{e.stopPropagation()})),e&&e.title&&fe("h4").text(e.title).appendTo(t);const a=fe("div"),s=fe("div");t.append(a,s),e&&e.set_contents&&e.set_contents(t,a,s);const o=fe("button.close").text(Te("toolbar-close")).appendTo(s),r=fe("div.cross").appendTo(s);o.on("click",(()=>{e.onclose&&e.onclose(),this.close()})),r.on("click",(()=>{e.onclose&&e.onclose(),this.close()})),ie.modal_window.append(t)},help(){this.open_func.common.call(this,{set_contents:(e,t,a)=>{e.classList.add("help");const s=be("#help-"+ie.lang_key);t.innerHTML=s.innerHTML}})},share(){const e=he.to_str(),t=location.href.split("?")[0]+"?share="+e;this.open_func.common.call(this,{title:Te("toolbar-share"),set_contents:(a,s,o)=>{function r(){const t=ie.map_cell[0].length,s=ie.map_cell.length;let o,r,n,i;"cell-size"===ie.save_data.embed_option.embed_size?(o=Math.max(1,ie.save_data.embed_option.cell_size),r=t*o,n=s*o,i=location.href.split("?")[0]+"emb.html?cellsize="+o+"&share="+e):(r=Math.max(1,Math.ceil(ie.save_data.embed_option.map_size)),n=Math.max(1,Math.ceil(ie.save_data.embed_option.map_size*s/t)),i=location.href.split("?")[0]+"emb.html?share="+e);const l=`<iframe frameborder="0" width="${r}" height="${n}" src="${i}"></iframe>`;a.querySelector("#embed-tag").value=l}["share-url","embed-tag"].forEach(((e,a)=>{const o=fe(`div.textarea-container.${e}`).appendTo(s),r=fe("h5").text(Te(`toolbar-${e}`)),n=fe(`textarea#${e}`),i=fe("button.copy").text(Te("toolbar-copy"));o.append(r,n,i),i.on("click",(e=>{(function(e){var t=fe("div"),a=document.createElement("pre");a.style.webkitUserSelect="auto",a.style.userSelect="auto",t.appendChild(a).textContent=e;var s=t.style;s.position="fixed",s.right="200%",document.body.appendChild(t),document.getSelection().selectAllChildren(t);var o=document.execCommand("copy");return document.body.removeChild(t),o})(n.value)&&(n.select(),pe.success(Te("toaster-success-copy")))})),"share-url"===e&&(n.textContent=t,o.append(fe("hr")))}));{fe("div.radio-container").appendTo(s).innerHTML='<input type="radio" name="embed-size" id="embed-size-1" key="cell-size"><label for="embed-size-1"><span>マスの大きさを指定する</span>(<input type="text" id="embed-cell-size">px)</label>',fe("div.radio-container").appendTo(s).innerHTML='<input type="radio" name="embed-size" id="embed-size-2" key="map-size"><label for="embed-size-2"><span>マップの横幅を指定する</span>(<input type="text" id="embed-map-size">px)</label>';const e=s.querySelector(`[name=embed-size][key=${ie.save_data.embed_option.embed_size}]`);e&&(e.checked=!0),s.querySelectorAll("[name=embed-size]").forEach((e=>{e.on("change",(t=>{ie.save_data.embed_option.embed_size=e.getAttribute("key"),_e.save(),r()}))}));const t=s.querySelector("#embed-cell-size");t.value=ie.save_data.embed_option.cell_size,t.on("input",(e=>{const a=parseInt(t.value);isNaN(a)||(ie.save_data.embed_option.cell_size=a,_e.save(),r())}));const a=s.querySelector("#embed-map-size");a.value=ie.save_data.embed_option.map_size,a.on("input",(e=>{const t=parseInt(a.value);isNaN(t)||(ie.save_data.embed_option.map_size=t,_e.save(),r())}))}r()}})},open(){this.open_func.common.call(this,{title:Te("toolbar-open"),set_contents:(e,t,a)=>{const s=Object.keys(ie.save_data.file).sort().reverse(),o=[];ie.save_data.file.autosave&&o.push(ie.save_data.file.autosave),s.forEach((e=>{"autosave"!==e&&o.push(ie.save_data.file[e])}));const r=fe("table.load").appendTo(t),n=fe("tr");fe("th").text(Te("open-table-title")).appendTo(n),fe("th").text(Te("open-table-created")).appendTo(n),fe("th").text(Te("open-table-modified")).appendTo(n),fe("th").text(Te("open-table-open")).appendTo(n),fe("th").text(Te("open-table-delete")).appendTo(n),r.append(n),o.forEach((e=>{const t=fe("tr"),a=fe("button.delete").text(Te("toolbar-open")),s=fe("button.delete").text(Te("toolbar-delete"));a.on("click",(t=>{Ie.load(e.created),pe.success(Te("toaster-success-load")),this.close()})),s.on("click",(a=>{confirm(Te("confirm-delete").replace("{name}",e.title))&&(delete ie.save_data.file[e.created],ie.save_data.last_file_key===e.created&&(ie.save_data.last_file_key=null),ie.current_file_key===e.created&&(ie.current_file_key=null),t.classList.add("delete"),_e.save(),setTimeout((()=>{t.remove()}),300))})),"autosave"===e.created&&s.style.setProperty("display","none"),fe("td.title").text(e.title).appendTo(t).on("click",(t=>{Ie.load(e.created),pe.success(Te("toaster-success-load")),this.close()})),fe("td.created").text("autosave"!==e.created?Ae(e.created):"-").appendTo(t),fe("td.modified").text(Ae(e.modified)).appendTo(t),fe("td.load").appendTo(t).append(a),fe("td.delete").appendTo(t).append(s),r.append(t)}))}})},save(){this.open_func.common.call(this,{title:Te("toolbar-save-as"),set_contents:(e,t,a)=>{e.on("keyup",(e=>{e.stopPropagation()})),e.on("keydown",(e=>{e.stopPropagation()})),e.on("click",(e=>{e.stopPropagation()}));const s=fe("input[type=text]").val("Untitled!").appendTo(t);fe("button.save").text(Te("toolbar-save")).appendTo(t).on("click",(e=>{const t=s.value;Ie.save_as(t),pe.success(Te("toaster-success-save")),close()}))}})},train(){this.open_func.common.call(this,{title:Te("toolbar-train"),classname:"train",onclose:()=>{const e=[];ye("ul.train li[wagon]").forEach((t=>{const a=t.attr("wagon");e.push(a)})),e.reverse(),ce.update_wagons(e),he.onchange()},set_contents:(e,t,a)=>{let s=null,o=null;const r=fe("ul.train").appendTo(t),n=fe("li.trash");function i(t){const a=fe("li[wagon="+t+"]");a.css("background-image","url(./assets/img/wagon/"+t+".png)"),a.on("mousedown",(()=>{s=a,s.css("opacity",.5),e.classList.add("dragging")})).on("mousemove",(e=>{if(s){const t=r.querySelectorAll("li"),o=Array.prototype.indexOf.call(t,s),n=Array.prototype.indexOf.call(t,a),i=a.getBoundingClientRect();a.css("border-left-color","transparent"),a.css("border-right-color","transparent"),e.clientX-i.left<a.clientWidth/2?o!==n&&o!==n-1&&(a.css("border-left-color","#2196f3"),a.css("border-right-color","transparent")):o!==n&&o!==n+1&&(a.css("border-left-color","transparent"),a.css("border-right-color","#2196f3"))}})).on("mouseenter",(e=>{if(o){const e=o.attr("wagon");a.css("background-image","url(./assets/img/wagon/"+e+".png)"),a.css("opacity",.5)}})).on("mouseleave",(()=>{if(s)a.css("border-left-color","transparent"),a.css("border-right-color","transparent");else if(o){const e=a.attr("wagon");a.css("background-image","url(./assets/img/wagon/"+e+".png)"),a.css("opacity",1)}})).on("mouseup",(e=>{if(s){const t=a.getBoundingClientRect();e.clientX-t.left<a.clientWidth/2?a.parentNode.insertBefore(s,a):a.parentNode.insertBefore(s,a.nextSibling),a.css("border-left-color","transparent"),a.css("border-right-color","transparent"),s.css("opacity",1),s=null,e.stopPropagation()}else if(o){const e=o.attr("wagon");a.css("background-image","url(./assets/img/wagon/"+e+".png)"),a.css("opacity",1),a.attr("wagon",e),o.css("opacity",1),o=null}})),r.insertBefore(a,n.nextSibling)}n.css("background-image","url(./assets/img/wagon/trash-close.png)"),n.on("mouseenter",(()=>{s&&n.css("background-image","url(./assets/img/wagon/trash-open.png)")})),n.on("mouseleave",(()=>{n.css("background-image","url(./assets/img/wagon/trash-close.png)")})),n.on("mouseup",(()=>{s&&(s.remove(),n.css("background-image","url(./assets/img/wagon/trash-close.png)"))})),r.append(n),e.on("mouseleave mouseup",(t=>{s&&(s.remove(),s=null),o&&(o.css("opacity",1),o=null),e.classList.remove("dragging")})),ce.wagon_names.forEach((e=>{i(e)}));const l=fe("ul.wagon-palette").appendTo(t);let c,d;ae.forEach((t=>{const a=fe("li[wagon="+t+"]");a.css("background-image","url(./assets/img/wagon/"+t+".png)"),a.on("click",(()=>{d=(new Date).getTime(),d-c<100&&i(t)})).on("mousedown",(()=>{c=(new Date).getTime(),a.css("opacity",.5),o=a,e.classList.add("dragging")})).on("mouseup",(()=>{a.css("opacity",1),o=null})),l.append(a)}));const p=fe("ul.description").appendTo(t);fe("li").text(Te("train-edit-description-1")).appendTo(p),fe("li").text(Te("train-edit-description-2")).appendTo(p),fe("li").text(Te("train-edit-description-3")).appendTo(p),fe("li").text(Te("train-edit-description-4")).appendTo(p)}})}}};window.addEventListener("keydown",(e=>{if("Shift"!==e.key||ie.key_state[e.key]||de.route(!1),"Alt"!==e.key||ie.key_state[e.key]||de.route(!0),e.key.match(/^F\d$/)&&!ie.key_state[e.key]){const t=parseInt(e.key.replace("F",""));t<=4&&(e.shiftKey?ue.save(t):ue.load(t),e.preventDefault())}ie.key_state[e.key]=!0}),{passive:!1}),window.addEventListener("keyup",(e=>{"Shift"===e.key&&(de.reset(),ie.last_highlight_cell=null,de.mouse()),"Alt"===e.key&&(ie.last_highlight_cell=null,de.reset(),de.mouse(),e.preventDefault()),ie.key_state[e.key]=!1}),{passive:!1}),window.addEventListener("mouseup",(e=>{ie.mouse_state.changed&&ue.push_undo_stack(),ie.mouse_state.is_down=!1,ie.mouse_state.changed=!1})),window.addEventListener("DOMContentLoaded",(s=>{le.log("Unrailed Map Maker Ver.1.4"),le.log("Thanks, Unrailed!");try{ye("[trans-key]").forEach((e=>{const t=Te(e.getAttribute("trans-key"));e.textContent=t})),ye(".version").forEach((t=>{t.textContent=e})),pe.init(),_e.load(),ie.main_window=be("#main-window"),ie.modal_window=be("#modal-window"),ie.count_wrapper=be("#count-wrapper"),ie.count_elm.wood=be("#count-wood"),ie.count_elm.iron=be("#count-iron"),ie.count_elm["r-wood"]=be("#count-r-wood"),ie.count_elm["r-iron"]=be("#count-r-iron"),ie.count_elm["r-rail"]=be("#count-r-rail"),ie.count_elm["c-rail"]=be("#count-c-rail"),ie.count_elm.bridge=be("#count-bridge"),function(){const e=fe("div#toolbar-wapper");{const t=fe("div.tool-container.file-tool"),s=(fe("h4").text(Te("toolbar-file")).appendTo(t),fe("input#file-name[type=text]"));s.on("click",(e=>{})),t.append(s);const o=fe("button#file-save.main-button").text(Te("toolbar-save")).appendTo(t);o.on("click",(e=>{o.classList.contains("enabled")&&(Ie.save(),pe.success(Te("toaster-success-save")))})),fe("button#file-save-as.main-button").text(Te("toolbar-save-as")).appendTo(t).on("click",(e=>{a.open("save")})),fe("button#file-load.main-button").text(Te("toolbar-open")).appendTo(t).on("click",(e=>{a.open("open")})),fe("button#file-new.main-button").text(Te("toolbar-new")).appendTo(t).on("click",(e=>{he.create_new()})),fe("button.main-button").text(Te("toolbar-share")).appendTo(t).on("click",(e=>{a.open("share")})),fe("button.main-button").text(Te("toolbar-download-image")).appendTo(t).on("click",(e=>{he.download_as_image()})),fe("button.main-button").text(Te("toolbar-help")).appendTo(t).on("click",(e=>{a.open("help")})),fe("button.main-button").text(Te("toolbar-undo")).appendTo(t).on("click",(e=>{ue.undo()})),fe("button.main-button").text(Te("toolbar-redo")).appendTo(t).on("click",(e=>{ue.redo()})),t.append(fe("div.split")),e.append(t)}{const t=fe("div.tool-container");fe("h4").text(Te("toolbar-map-size")).appendTo(t),["x","y"].forEach((e=>{const a=fe(`div.map-size-container[dir=${e}]`),s=fe("input.map-size[type=text]");s.value="x"===e?40:20,s.on("keydown",(e=>{"Enter"===e.key&&s.blur()})),s.on("change",(e=>{let t=parseInt(s.value);t=Math.max(1,Math.min(99,t)),s.value=t,he.change_map_size()}));const o=fe("button.input-side-button.map-size-button-1").text("-");o.on("click",(e=>{let t=parseInt(s.value);t=Math.max(1,Math.min(99,t-1)),s.value=t,he.change_map_size()}));const r=fe("button.input-side-button.map-size-button-2").text("+");r.on("click",(e=>{let t=parseInt(s.value);t=Math.max(1,Math.min(99,t+1)),s.value=t,he.change_map_size()})),a.append(s,o,r),t.append(a)})),t.append(fe("div.split")),e.append(t)}{const t=fe("div.tool-container");{const e=fe("input[type=checkbox][id=input-grid]");e.on("change",(t=>{e.checked?(ie.save_data.option.is_enabled_grid=!0,ie.main_window.classList.add("grid")):(ie.save_data.option.is_enabled_grid=!1,ie.main_window.classList.remove("grid")),_e.save()})),ie.save_data.option.is_enabled_grid&&(e.checked=!0,e.trigger("change"));const a=fe("label[for=input-grid]").text(Te("toolbar-grid"));t.append(e,a)}t.append(fe("div.split"));{const e=fe("input[type=checkbox][id=input-count]");e.on("change",(t=>{e.checked?(ie.save_data.option.is_enabled_count=!0,ie.count_wrapper.classList.remove("hidden")):(ie.save_data.option.is_enabled_count=!1,ie.count_wrapper.classList.add("hidden")),_e.save()})),ie.save_data.option.is_enabled_count&&(e.checked=!0,e.trigger("change"));const a=fe("label[for=input-count]").text(Te("toolbar-count"));t.append(e,a)}t.append(fe("div.split")),e.append(t),e.append(fe("br"))}{const t=fe("div.tool-container.palette"),a=(fe("h4").text(Te("toolbar-grounds")).appendTo(t),fe("ul"));[i,l,c,m,p,d,u,g,y,f].forEach((e=>{const t=fe(`li.palette-item[land-type=${e}]`);switch(t.setAttribute("title",Te("palette-"+e)),t.on("click",(a=>{ye(".selected-item").forEach((e=>{e.classList.remove("selected-item")})),t.classList.add("selected-item"),ie.mouse_state.current_palette_item=e===f?f.replace("1",t.getAttribute("color-id")):e,ie.mouse_state.current_palette_type=G})),e){case f:{t.setAttribute("color-id",1),t.on("mouseenter",(e=>{t.classList.add("hover")})),t.on("mouseleave",(e=>{t.classList.remove("hover")})),t.style.setProperty("background-image","url(./assets/img/color/1.png)");const e=fe("ul");e.style.setProperty("--count-x","1"),e.style.setProperty("--count-y","10");for(let a=1;a<=10;a++){const s=fe("li");s.style.setProperty("background-image",`url(./assets/img/color/${a}.png)`),s.on("click",(e=>{ye(".selected-wrapper").forEach((e=>{e.classList.remove("selected-wrapper")})),t.classList.add("selected-wrapper"),t.classList.remove("hover"),t.style.setProperty("background-image",`url(./assets/img/color/${a}.png)`),t.setAttribute("color-id",a)})),e.append(s)}t.append(e);break}}a.append(t)})),t.append(a),t.append(fe("div.split")),e.append(t)}{const t=fe("div.tool-container.palette"),a=(fe("h4").text(Te("toolbar-items")).appendTo(t),fe("ul"));[N,S,P,$,C,D,B,z,W,R].forEach(((e,t)=>{const s=1<=t&&t<=4?"plains":"common",o=fe("li.palette-item");o.setAttribute("title",Te("palette-"+e));const r=e+(e.includes("rail")?"-rl":"");switch(o.style.setProperty("background-image",`url(./assets/img/${s}/${r}.png)`),o.on("click",(t=>{switch(ye(".selected-item").forEach((e=>{e.classList.remove("selected-item")})),o.classList.add("selected-item"),ie.mouse_state.current_palette_type=J,e){case z:ie.mouse_state.current_palette_item=o.getAttribute("backet-state");break;case W:ie.mouse_state.current_palette_item=W.replace("1",o.getAttribute("dynamite-level"));break;default:ie.mouse_state.current_palette_item=e}})),e){case z:{o.setAttribute("backet-state",z),o.on("mouseenter",(e=>{o.classList.add("hover")})),o.on("mouseleave",(e=>{o.classList.remove("hover")})),o.style.setProperty("background-image","url(./assets/img/common/resource-backet.png)");const e=fe("ul");e.style.setProperty("--count-y","2"),[z,O].forEach((t=>{const a=fe("li");a.style.setProperty("background-image",`url(./assets/img/common/${t}.png)`),a.on("click",(e=>{ye(".selected-wrapper").forEach((e=>{e.classList.remove("selected-wrapper")})),o.classList.add("selected-wrapper"),o.classList.remove("hover"),o.style.setProperty("background-image",`url(./assets/img/common/${t}.png)`),o.setAttribute("backet-state",t),o.setAttribute("title",Te("palette-"+t))})),e.append(a)})),o.append(e);break}case W:{o.setAttribute("dynamite-level",1),o.setAttribute("id","resource-dynamite"),o.on("mouseenter",(e=>{o.classList.add("hover")})),o.on("mouseleave",(e=>{o.classList.remove("hover")})),o.style.setProperty("background-image","url(./assets/img/common/dynamite-1.png)");const e=fe("ul");e.style.setProperty("--count-y","9");for(let t=1;t<=9;t++){const a=fe("li");a.style.setProperty("background-image",`url(./assets/img/common/dynamite-${t}.png)`),a.setAttribute("title",Te("palette-resource-dynamite-"+t)),a.on("click",(e=>{ye(".selected-wrapper").forEach((e=>{e.classList.remove("selected-wrapper")})),o.classList.add("selected-wrapper"),o.classList.remove("hover"),o.style.setProperty("background-image",`url(./assets/img/common/dynamite-${t}.png)`),o.setAttribute("dynamite-level",t),o.setAttribute("title",Te("palette-"+W.replace("1",t)))})),e.append(a)}o.append(e);break}case j:{o.setAttribute("id","palette-face"),o.setAttribute("face-id",13),o.on("mouseenter",(e=>{o.classList.add("hover")})),o.on("mouseleave",(e=>{o.classList.remove("hover")})),o.style.setProperty("background-image","url(./assets/img/face/face-13.png)");const e=fe("ul");e.style.setProperty("--count-x","8"),e.style.setProperty("--count-y","6"),e.style.setProperty("left","initial"),e.style.setProperty("right","-29px");for(let t=1;t<=41;t++){const a=fe("li");a.style.setProperty("background-image",`url(./assets/img/face/face-${t}.png)`),a.on("click",(e=>{ye(".selected-wrapper").forEach((e=>{e.classList.remove("selected-wrapper")})),o.classList.add("selected-wrapper"),o.classList.remove("hover"),o.style.setProperty("background-image",`url(./assets/img/face/face-${t}.png)`),o.setAttribute("face-id",t)})),e.append(a)}o.append(e);break}}a.append(o)})),t.append(a),t.append(fe("div.split")),e.append(t)}{const t=fe("div.tool-container.palette"),a=(fe("h4").text(Te("toolbar-symbols")).appendTo(t),fe("ul"));[Q,q,F].forEach(((e,t)=>{const s=fe("li.palette-item");switch(s.setAttribute("title",Te("palette-"+e)),s.style.setProperty("background-image",`url(./assets/img/common/${e}.png)`),s.on("click",(t=>{switch(ye(".selected-item").forEach((e=>{e.classList.remove("selected-item")})),s.classList.add("selected-item"),ie.mouse_state.current_palette_type=V,e){case z:ie.mouse_state.current_palette_item=s.getAttribute("backet-state");break;case W:ie.mouse_state.current_palette_item=W.replace("1",s.getAttribute("dynamite-level"));break;default:ie.mouse_state.current_palette_item=e}})),e){case q:{s.setAttribute("id","palette-symbol"),s.setAttribute("symbol-id",10),s.on("mouseenter",(e=>{s.classList.add("hover")})),s.on("mouseleave",(e=>{s.classList.remove("hover")})),s.style.setProperty("background-image","url(./assets/img/symbol/10.png)");const e=fe("ul");e.style.setProperty("--count-x","10"),e.style.setProperty("--count-y","5"),e.style.setProperty("left","initial"),e.style.setProperty("right","-31px");for(let t=0;t<=49;t++){const a=fe("li");a.style.setProperty("background-image",`url(./assets/img/symbol/${t}.png)`),a.on("click",(e=>{ye(".selected-wrapper").forEach((e=>{e.classList.remove("selected-wrapper")})),s.classList.add("selected-wrapper"),s.classList.remove("hover"),s.style.setProperty("background-image",`url(./assets/img/symbol/${t}.png)`),s.setAttribute("symbol-id",t)})),e.append(a)}s.append(e);break}case F:{s.setAttribute("id","palette-symbol-face"),s.setAttribute("face-id",13),s.on("mouseenter",(e=>{s.classList.add("hover")})),s.on("mouseleave",(e=>{s.classList.remove("hover")})),s.style.setProperty("background-image","url(./assets/img/face/face-13.png)");const e=fe("ul");e.style.setProperty("--count-x","8"),e.style.setProperty("--count-y","6"),e.style.setProperty("left","initial"),e.style.setProperty("right","-29px");for(let t=1;t<=41;t++){const a=fe("li");a.style.setProperty("background-image",`url(./assets/img/face/face-${t}.png)`),a.on("click",(e=>{ye(".selected-wrapper").forEach((e=>{e.classList.remove("selected-wrapper")})),s.classList.add("selected-wrapper"),s.classList.remove("hover"),s.style.setProperty("background-image",`url(./assets/img/face/face-${t}.png)`),s.setAttribute("face-id",t)})),e.append(a)}s.append(e);break}}a.append(s)})),t.append(a),t.append(fe("div.split")),e.append(t)}{const t=fe("div.tool-container.palette.mine-palette-wrapper"),a=(fe("h4").text(Te("toolbar-mine-tools")).appendTo(t),fe("ul"));[X,Y].forEach(((e,t)=>{const s=fe("li.palette-item");if(s.setAttribute("title",Te("palette-"+e)),s.setAttribute("resource-type",e),s.style.setProperty("background-image",`url(./assets/img/common/${e}.png)`),s.on("click",(t=>{ye(".selected-item").forEach((e=>{e.classList.remove("selected-item")})),s.classList.add("selected-item"),ie.mouse_state.current_palette_item=e,ie.mouse_state.current_palette_type=K})),e===Y){s.setAttribute("dynamite-level",1),s.setAttribute("id","mine-dynamite"),s.on("mouseenter",(e=>{s.classList.add("hover")})),s.on("mouseleave",(e=>{s.classList.remove("hover")})),s.style.setProperty("background-image","url(./assets/img/common/dynamite-1.png)");const e=fe("ul");for(let t=1;t<=9;t++){const a=fe("li");a.style.setProperty("background-image",`url(./assets/img/common/dynamite-${t}.png)`),a.on("click",(e=>{ye(".selected-wrapper").forEach((e=>{e.classList.remove("selected-wrapper")})),s.classList.add("selected-wrapper"),s.classList.remove("hover"),s.style.setProperty("background-image",`url(./assets/img/common/dynamite-${t}.png)`),s.setAttribute("dynamite-level",t)})),e.append(a)}s.append(e)}a.append(s)})),t.append(a),t.append(fe("div.split")),e.append(t)}{const t=fe("div.tool-container.palette.train-tool"),s=(fe("h4").text(Te("toolbar-train")).appendTo(t),fe("ul")),o=fe("li.palette-item");let r,n,i,l;o.setAttribute("title",Te("palette-train")),o.style.setProperty("background-image","url(./assets/img/common/train.png)"),o.on("click",(e=>{ye(".selected-item").forEach((e=>{e.classList.remove("selected-item")})),o.classList.add("selected-item"),ie.mouse_state.current_palette_item="train",ie.mouse_state.current_palette_type=Z})),s.append(o),t.append(s);const c=1,d=.05,p=33;fe("button.main-button").text("≪").appendTo(t).on("mousedown",(e=>{const t=-c;ce.step(t),r=setTimeout((()=>{r=setInterval((()=>{ce.step(t)}),p)}),100)})).on("mouseup mouseleave",(e=>{clearInterval(r),he.onchange()})),fe("button.main-button").css("margin-left","0").text("＜").appendTo(t).on("mousedown",(e=>{const t=-d;ce.step(t),n=setTimeout((()=>{n=setInterval((()=>{ce.step(t)}),p)}),100)})).on("mouseup mouseleave",(e=>{clearInterval(n),he.onchange()})),fe("button.main-button").css("margin-left","0").text("＞").appendTo(t).on("mousedown",(e=>{const t=d;ce.step(t),i=setTimeout((()=>{i=setInterval((()=>{ce.step(t)}),p)}),100)})).on("mouseup mouseleave",(e=>{clearInterval(i),he.onchange()})),fe("button.main-button").css("margin-left","0").text("≫").appendTo(t).on("mousedown",(e=>{const t=c;ce.step(t),l=setTimeout((()=>{l=setInterval((()=>{ce.step(t)}),p)}),100)})).on("mouseup mouseleave",(e=>{clearInterval(l),he.onchange()})),fe("button.main-button").text(Te("toolbar-train-reverse")).appendTo(t).on("click",(e=>{ce.reverse(),he.onchange()})),fe("button.main-button").text(Te("toolbar-train-edit")).appendTo(t).on("click",(e=>{a.open("train")})),fe("button.main-button").text(Te("toolbar-train-remove")).appendTo(t).on("click",(e=>{ce.remove(),he.onchange()})),t.append(fe("div.split")),e.append(t)}ie.main_window.append(e)}(),ie.map_wrapper=fe("div#map-table-wrapper.hidden").appendTo(ie.main_window),setTimeout((()=>{ie.map_wrapper.classList.remove("hidden")}),200),ie.url_queries.share?(he.open_str(ie.url_queries.share),pe.success(Te("toaster-load-share-url")),le.hr(),le.log("Loaded the URL query paramater."),le.hr(),put_train()):ie.save_data.last_file_key?(Ie.load(ie.save_data.last_file_key),pe.gray(Te("toaster-init").replace("{num}",e),4e3),le.hr(),le.log("Loaded the save data."),le.hr()):(he.make_table(t,40,20,!1),pe.gray(Te("toaster-init").replace("{num}",e),4e3),le.hr(),le.log("Initialized the map table."),le.hr())}catch(s){le.error("An error occurred during initialization."),console.error(s)}}))})()})();